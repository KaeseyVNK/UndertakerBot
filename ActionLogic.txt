const { SlashCommandBuilder } = require('discord.js');
const gameManager = require('../../game/GameManager');
const { createDeck, shuffleDeck } = require('../../game/Deck');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('flip7')
        .setDescription('ChÆ¡i game Flip 7!')
        .addSubcommand(subcommand =>
            subcommand
                .setName('start')
                .setDescription('Báº¯t Ä‘áº§u má»™t phÃ²ng chÆ¡i Flip 7 má»›i.'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('join')
                .setDescription('Tham gia vÃ o phÃ²ng chÆ¡i Flip 7.'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('begin')
                .setDescription('Báº¯t Ä‘áº§u vÃ¡n game (chá»‰ chá»§ phÃ²ng).'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('leave')
                .setDescription('Rá»i khá»i phÃ²ng chÆ¡i Flip 7.'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('hit')
                .setDescription('RÃºt thÃªm má»™t lÃ¡ bÃ i.'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('stay')
                .setDescription('Dá»«ng lÆ°á»£t vÃ  giá»¯ láº¡i Ä‘iá»ƒm hiá»‡n táº¡i.'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('hand')
                .setDescription('Xem láº¡i cÃ¡c lÃ¡ bÃ i trÃªn tay cá»§a báº¡n.'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('status')
                .setDescription('Xem tráº¡ng thÃ¡i hiá»‡n táº¡i cá»§a bÃ n chÆ¡i.')),
    async execute(interaction) {
        const subcommand = interaction.options.getSubcommand();
        const channelId = interaction.channelId;

        if (subcommand === 'start') {
            const { game, error } = gameManager.createGame(channelId);

            if (error) {
                return interaction.reply({ content: error, ephemeral: true });
            }

            // ThÃªm ngÆ°á»i táº¡o phÃ²ng lÃ m ngÆ°á»i chÆ¡i Ä‘áº§u tiÃªn
            const host = interaction.user;
            game.players.push({
                id: host.id,
                username: host.username,
                score: 0,
                totalScore: 0,
                hand: [],
            });

            return interaction.reply(`PhÃ²ng chÆ¡i Flip 7 Ä‘Ã£ Ä‘Æ°á»£c táº¡o bá»Ÿi **${host.username}**! DÃ¹ng lá»‡nh \`/flip7 join\` Ä‘á»ƒ tham gia.`);
        } else if (subcommand === 'join') {
            const game = gameManager.getGame(channelId);

            if (!game) {
                return interaction.reply({ content: 'KhÃ´ng cÃ³ phÃ²ng chÆ¡i nÃ o Ä‘ang hoáº¡t Ä‘á»™ng á»Ÿ kÃªnh nÃ y. DÃ¹ng `/flip7 start` Ä‘á»ƒ táº¡o phÃ²ng.', ephemeral: true });
            }

            if (game.gameState !== 'waiting') {
                return interaction.reply({ content: 'Ráº¥t tiáº¿c, vÃ¡n game Ä‘Ã£ báº¯t Ä‘áº§u. Báº¡n khÃ´ng thá»ƒ tham gia ná»¯a.', ephemeral: true });
            }

            if (game.players.find(p => p.id === interaction.user.id)) {
                return interaction.reply({ content: 'Báº¡n Ä‘Ã£ á»Ÿ trong phÃ²ng chÆ¡i rá»“i.', ephemeral: true });
            }

            if (game.players.length >= 4) {
                return interaction.reply({ content: 'Ráº¥t tiáº¿c, phÃ²ng Ä‘Ã£ Ä‘á»§ 4 ngÆ°á»i chÆ¡i.', ephemeral: true });
            }

            const newUser = interaction.user;
            game.players.push({
                id: newUser.id,
                username: newUser.username,
                score: 0,
                totalScore: 0,
                hand: [],
            });

            return interaction.reply(`**${newUser.username}** Ä‘Ã£ tham gia phÃ²ng chÆ¡i! Hiá»‡n táº¡i cÃ³ ${game.players.length}/4 ngÆ°á»i chÆ¡i.`);
        } else if (subcommand === 'leave') {
            const game = gameManager.getGame(channelId);

            if (!game) {
                return interaction.reply({ content: 'KhÃ´ng cÃ³ phÃ²ng chÆ¡i nÃ o Ä‘ang hoáº¡t Ä‘á»™ng á»Ÿ kÃªnh nÃ y.', ephemeral: true });
            }

            const playerIndex = game.players.findIndex(p => p.id === interaction.user.id);

            if (playerIndex === -1) {
                return interaction.reply({ content: 'Báº¡n khÃ´ng cÃ³ trong phÃ²ng chÆ¡i nÃ y.', ephemeral: true });
            }

            const leavingUser = game.players[playerIndex];
            game.players.splice(playerIndex, 1);

            // Náº¿u host rá»i Ä‘i vÃ  cÃ²n ngÆ°á»i khÃ¡c, chuyá»ƒn host cho ngÆ°á»i tiáº¿p theo
            if (playerIndex === 0 && game.players.length > 0) {
                 return interaction.reply(`**${leavingUser.username}** Ä‘Ã£ rá»i phÃ²ng. **${game.players[0].username}** hiá»‡n lÃ  chá»§ phÃ²ng má»›i. (${game.players.length}/4)`);
            }

            // Náº¿u khÃ´ng cÃ²n ai, xÃ³a game
            if (game.players.length === 0) {
                gameManager.endGame(channelId);
                return interaction.reply(`**${leavingUser.username}** Ä‘Ã£ rá»i phÃ²ng. PhÃ²ng chÆ¡i Ä‘Ã£ Ä‘Æ°á»£c giáº£i tÃ¡n vÃ¬ khÃ´ng cÃ²n ai.`);
            }

            return interaction.reply(`**${leavingUser.username}** Ä‘Ã£ rá»i khá»i phÃ²ng chÆ¡i. Hiá»‡n táº¡i cÃ³ ${game.players.length}/4 ngÆ°á»i chÆ¡i.`);
        } else if (subcommand === 'begin') {
            const game = gameManager.getGame(channelId);

            if (!game || game.players.length === 0) {
                return interaction.reply({ content: 'KhÃ´ng cÃ³ phÃ²ng chÆ¡i nÃ o Ä‘á»ƒ báº¯t Ä‘áº§u.', ephemeral: true });
            }

            if (game.players[0].id !== interaction.user.id) {
                return interaction.reply({ content: 'Chá»‰ cÃ³ chá»§ phÃ²ng má»›i cÃ³ thá»ƒ báº¯t Ä‘áº§u vÃ¡n game.', ephemeral: true });
            }

            if (game.gameState === 'in-progress') {
                return interaction.reply({ content: 'VÃ¡n game Ä‘Ã£ báº¯t Ä‘áº§u rá»“i.', ephemeral: true });
            }

            game.gameState = 'in-progress';
            const deck = createDeck();
            game.deck = shuffleDeck(deck);

            // Deal one card to each player
            game.players.forEach(player => {
                const card = gameManager.drawCard(game);
                if(card.type === 'action' && card.name === 'Flip Three') {
                    player.hand.push(card);
                    player.hand.push(gameManager.drawCard(game));
                    player.hand.push(gameManager.drawCard(game));
                    player.hand.push(gameManager.drawCard(game));
                }
                else if(card.type === 'action' && card.name === 'Freeze') {
                    game.currentPlayerIndex = (game.currentPlayerIndex + 1) % game.players.length; // Next player
                    const nextPlayer = game.players[game.currentPlayerIndex];
                    return interaction.reply(`**${player.username}** Ä‘Ã£ rÃºt lÃ¡ **${card.name}** nÃªn bá»‹ **Máº¥t lÆ°á»£t!**\n\nÄáº¿n lÆ°á»£t cá»§a **${nextPlayer.username}**.`);
                }
                else if(card.type === 'action' && card.name === 'Second Chance') {
                    player.hand.push(card);
                }
                else {
                    player.hand.push(card);
                }
            });

            // TODO: Create a proper game state embed
            const hands = game.players.map(p => `**${p.username}**: ${p.hand.map(c => c.name).join(', ')}`).join('\n');
            const currentPlayer = game.players[game.currentPlayerIndex];

            return interaction.reply(`Game Ä‘Ã£ báº¯t Ä‘áº§u!\n\n${hands}\n\nÄáº¿n lÆ°á»£t cá»§a **${currentPlayer.username}**. DÃ¹ng \`/flip7 hit\` hoáº·c \`/flip7 stay\`.`);

        } else if (subcommand === 'hit') {
            const game = gameManager.getGame(channelId);
            const player = game.players[game.currentPlayerIndex];

            if (!game || game.gameState !== 'in-progress') {
                return interaction.reply({ content: 'VÃ¡n game chÆ°a báº¯t Ä‘áº§u hoáº·c Ä‘Ã£ káº¿t thÃºc.', ephemeral: true });
            }

            if (player.id !== interaction.user.id) {
                return interaction.reply({ content: 'ChÆ°a Ä‘áº¿n lÆ°á»£t cá»§a báº¡n.', ephemeral: true });
            }

            await interaction.deferReply();

            const newCard = gameManager.drawCard(game);

            // Xá»¬ LÃ LÃ 'FREEZE'
            if (newCard.name === 'Freeze') {
                player.hasStayed = true; // Dá»«ng lÆ°á»£t chÆ¡i

                let roundScore = 0;
                const numberCards = player.hand.filter(c => c.type === 'number');
                const modifierCards = player.hand.filter(c => c.type === 'modifier');
                let hasX2 = false;

                roundScore = numberCards.reduce((sum, card) => sum + card.value, 0);
                modifierCards.forEach(mod => {
                    if (mod.name === 'x2') hasX2 = true;
                    else roundScore += mod.value;
                });
                if (hasX2) roundScore *= 2;

                player.score = roundScore;
                player.totalScore += player.score;

                if (player.totalScore >= 200) {
                    gameManager.endGame(interaction.channelId);
                    return interaction.editReply(`**${player.username}** rÃºt trÃºng lÃ¡ **Freeze** vÃ  dá»«ng lÆ°á»£t!\nğŸ‰ **${player.username.toUpperCase()} LÃ€ NGÆ¯á»œI CHIáº¾N THáº®NG!** ğŸ‰\n**${player.username}** Ä‘Ã£ Ä‘áº¡t Ä‘Æ°á»£c **${player.totalScore}** Ä‘iá»ƒm vÃ  káº¿t thÃºc trÃ² chÆ¡i!`);
                }

                game.currentPlayerIndex = (game.currentPlayerIndex + 1) % game.players.length;
                const nextPlayer = game.players[game.currentPlayerIndex];

                const replyMessage = `**${player.username}** Ä‘Ã£ rÃºt lÃ¡ **Freeze** vÃ  pháº£i dá»«ng lÆ°á»£t!\nÄiá»ƒm vÃ²ng nÃ y: **${player.score}**. Tá»•ng Ä‘iá»ƒm: **${player.totalScore}**.\n\nÄáº¿n lÆ°á»£t cá»§a **${nextPlayer.username}**.`;

                player.hand = [];
                player.score = 0;
                player.isBusted = false;
                player.hasStayed = false;

                return interaction.editReply(replyMessage);
            }

            player.hand.push(newCard);
            let drawnCardsMessage = `**${player.username}** Ä‘Ã£ rÃºt lÃ¡ **${newCard.name}**.`;

            // Xá»¬ LÃ LÃ 'FLIP THREE'
            if (newCard.name === 'Flip Three') {
                const extraCards = [];
                for (let i = 0; i < 3; i++) {
                    const extraCard = gameManager.drawCard(game);
                    if (extraCard) {
                        player.hand.push(extraCard);
                        extraCards.push(`**${extraCard.name}**`);
                    }
                }
                drawnCardsMessage = `**${player.username}** rÃºt trÃºng **Flip Three** vÃ  bá»‘c thÃªm 3 lÃ¡: ${extraCards.join(', ')}.`;
            }

            const numberCardsInHand = player.hand.filter(c => c.type === 'number');

            // THáº®NG NGAY Láº¬P Tá»¨C: 7 lÃ¡ bÃ i sá»‘ khÃ¡c nhau
            if (numberCardsInHand.length >= 7) {
                const uniqueNumberValues = new Set(numberCardsInHand.map(c => c.value));

                if (uniqueNumberValues.size >= 7) {
                    player.hasStayed = true; // Káº¿t thÃºc lÆ°á»£t chÆ¡i cá»§a ngÆ°á»i nÃ y

                    // TÃ­nh Ä‘iá»ƒm
                    let finalScore = numberCardsInHand.reduce((sum, val) => sum + val.value, 0);
                    const modifiers = player.hand.filter(c => c.type === 'modifier');
                    let hasX2 = false;

                    modifiers.forEach(mod => {
                        if (mod.name === 'x2') hasX2 = true;
                        else finalScore += mod.value;
                    });

                    finalScore += 15; // Cá»™ng 15 Ä‘iá»ƒm thÆ°á»Ÿng
                    if (hasX2) finalScore *= 2;

                    player.score = finalScore;
                    player.totalScore += player.score;

                    if (player.totalScore >= 200) {
                        gameManager.endGame(interaction.channelId);
                        return interaction.editReply(`${drawnCardsMessage}\nğŸ‰ **FLIP 7!** ğŸ‰\n**${player.username}** cÃ³ 7 lÃ¡ bÃ i sá»‘ khÃ¡c nhau vÃ  tháº¯ng!\nğŸ‰ **${player.username.toUpperCase()} LÃ€ NGÆ¯á»œI CHIáº¾N THáº®NG!** ğŸ‰\nVá»›i **${player.totalScore}** Ä‘iá»ƒm, trÃ² chÆ¡i káº¿t thÃºc!`);
                    }

                    game.currentPlayerIndex = (game.currentPlayerIndex + 1) % game.players.length;
                    const nextPlayer = game.players[game.currentPlayerIndex];

                    const replyMessage = `${drawnCardsMessage}\nğŸ‰ **FLIP 7!** ğŸ‰\n**${player.username}** Ä‘Ã£ cÃ³ 7 lÃ¡ bÃ i sá»‘ khÃ¡c nhau vÃ  tháº¯ng ngay láº­p tá»©c!\nÄiá»ƒm vÃ²ng nÃ y: **${player.score}**\nTá»•ng Ä‘iá»ƒm: **${player.totalScore}**\n\nÄáº¿n lÆ°á»£t cá»§a **${nextPlayer.username}**.`

                    player.hand = [];
                    player.score = 0;
                    player.isBusted = false;
                    player.hasStayed = false;

                    return interaction.editReply(replyMessage);
                }
            }
            
            const hasDuplicate = new Set(numberCardsInHand.map(c => c.name)).size !== numberCardsInHand.length;

            if (hasDuplicate) {
                const secondChanceIndex = player.hand.findIndex(c => c.name === 'Second Chance');

                if (secondChanceIndex !== -1) {
                    player.hand.splice(secondChanceIndex, 1); // DÃ¹ng lÃ¡ Second Chance
                    const bustedCard = player.hand.pop(); // Bá» lÃ¡ bÃ i vá»«a rÃºt gÃ¢y trÃ¹ng

                    player.score = player.hand.filter(c => c.type === 'number').reduce((sum, card) => sum + card.value, 0);

                    return interaction.editReply(`${drawnCardsMessage}\n**${player.username}** suÃ½t ná»¯a thÃ¬ BUST nhÆ°ng Ä‘Ã£ Ä‘Æ°á»£c **Second Chance** cá»©u!\nBÃ i cá»§a báº¡n: ${player.hand.map(c => c.name).join(', ')}\nÄiá»ƒm vÃ²ng nÃ y: **${player.score}**\n\nTiáº¿p tá»¥c \`hit\` hay \`stay\`?`);
                } else {
                    // BUST!
                    const nextPlayer = game.players[(game.currentPlayerIndex + 1) % game.players.length];
                    const replyMessage = `${drawnCardsMessage}\n... vÃ  **BUST!**\nÄiá»ƒm cá»§a vÃ²ng: **0**\nTá»•ng Ä‘iá»ƒm: **${player.totalScore}**\n\nÄáº¿n lÆ°á»£t cá»§a **${nextPlayer.username}**.`

                    player.score = 0;
                    player.hand = [];
                    player.isBusted = false;
                    player.hasStayed = false;
                    game.currentPlayerIndex = (game.currentPlayerIndex + 1) % game.players.length; // LÆ°á»£t cá»§a ngÆ°á»i chÆ¡i tiáº¿p theo

                    return interaction.editReply(replyMessage);
                }
            }

            // TÃ­nh láº¡i Ä‘iá»ƒm cá»§a vÃ²ng náº¿u khÃ´ng bust vÃ  khÃ´ng cÃ³ Flip 7
            player.score = numberCardsInHand.reduce((sum, card) => sum + card.value, 0);

            return interaction.editReply(`${drawnCardsMessage}\nBÃ i cá»§a báº¡n: ${player.hand.map(c => c.name).join(', ')}\nÄiá»ƒm cá»§a vÃ²ng: **${player.score}**\nTá»•ng Ä‘iá»ƒm: **${player.totalScore}**\n\nTiáº¿p tá»¥c \`hit\` hay \`stay\`?`);

        } else if (subcommand === 'stay') {
            const game = gameManager.getGame(channelId);
            const player = game.players[game.currentPlayerIndex];

            if (!game || game.gameState !== 'in-progress') {
                return interaction.reply({ content: 'VÃ¡n game chÆ°a báº¯t Ä‘áº§u hoáº·c Ä‘Ã£ káº¿t thÃºc.', ephemeral: true });
            }

            if (player.id !== interaction.user.id) {
                return interaction.reply({ content: 'ChÆ°a Ä‘áº¿n lÆ°á»£t cá»§a báº¡n.', ephemeral: true });
            }

            player.hasStayed = true;

            // TÃ­nh Ä‘iá»ƒm vÃ²ng nÃ y vá»›i logic MODIFIERS
            let roundScore = 0;
            const numberCards = player.hand.filter(c => c.type === 'number');
            const modifierCards = player.hand.filter(c => c.type === 'modifier');
            let hasX2 = false;

            // 1. Cá»™ng Ä‘iá»ƒm tá»« cÃ¡c lÃ¡ bÃ i sá»‘
            roundScore = numberCards.reduce((sum, card) => sum + card.value, 0);

            // 2. Xá»­ lÃ½ cÃ¡c lÃ¡ MODIFIERS
            modifierCards.forEach(mod => {
                if (mod.name === 'x2') {
                    hasX2 = true;
                } else {
                    roundScore += mod.value; // Cá»™ng cÃ¡c giÃ¡ trá»‹ nhÆ° +2, +4
                }
            });

            // 3. Ãp dá»¥ng x2 sau khi Ä‘Ã£ cá»™ng táº¥t cáº£
            if (hasX2) {
                roundScore *= 2;
            }

            player.score = roundScore;
            player.totalScore += player.score;

            // KIá»‚M TRA NGÆ¯á»œI CHIáº¾N THáº®NG
            if (player.totalScore >= 200) {
                gameManager.endGame(interaction.channelId);
                return interaction.reply(`ğŸ‰ **${player.username.toUpperCase()} LÃ€ NGÆ¯á»œI CHIáº¾N THáº®NG!** ğŸ‰\n**${player.username}** Ä‘Ã£ Ä‘áº¡t Ä‘Æ°á»£c **${player.totalScore}** Ä‘iá»ƒm vÃ  káº¿t thÃºc trÃ² chÆ¡i!\n\nDÃ¹ng \`/flip7 start\` Ä‘á»ƒ báº¯t Ä‘áº§u má»™t vÃ¡n má»›i.`);
            }

            // Chuyá»ƒn lÆ°á»£t cho ngÆ°á»i chÆ¡i tiáº¿p theo
            game.currentPlayerIndex = (game.currentPlayerIndex + 1) % game.players.length;
            const nextPlayer = game.players[game.currentPlayerIndex];

            const message = `**${player.username}** Ä‘Ã£ chá»n dá»«ng láº¡i vá»›i **${player.score}** Ä‘iá»ƒm trong vÃ²ng nÃ y.\nTá»•ng Ä‘iá»ƒm: **${player.totalScore}**.\n\nÄáº¿n lÆ°á»£t cá»§a **${nextPlayer.username}**.`;

            player.hand = [];
            player.score = 0;
            player.isBusted = false;
            player.hasStayed = false;

            // TODO: Check if the round is over
            return interaction.reply(message);

        } else if (subcommand === 'hand') {
            const game = gameManager.getGame(channelId);

            if (!game) {
                return interaction.reply({ content: 'KhÃ´ng cÃ³ phÃ²ng chÆ¡i nÃ o Ä‘ang hoáº¡t Ä‘á»™ng á»Ÿ kÃªnh nÃ y.', ephemeral: true });
            }

            const player = game.players.find(p => p.id === interaction.user.id);

            if (!player) {
                return interaction.reply({ content: 'Báº¡n khÃ´ng cÃ³ trong phÃ²ng chÆ¡i nÃ y.', ephemeral: true });
            }

            const hands = game.players.map(p => `**${p.username}**: ${p.hand.map(c => c.name).join(', ')}`).join('\n');
            return interaction.reply(`CÃ¡c lÃ¡ bÃ i trÃªn tay cá»§a báº¡n:\n${hands}`);
        } else if (subcommand === 'status') {
            const game = gameManager.getGame(channelId);

            if (!game) {
                return interaction.reply({ content: 'KhÃ´ng cÃ³ phÃ²ng chÆ¡i nÃ o Ä‘ang hoáº¡t Ä‘á»™ng á»Ÿ kÃªnh nÃ y.', ephemeral: true });
            }

            const gameState = game.gameState;
            const players = game.players.map(p => `**${p.username}**: ${p.score} Ä‘iá»ƒm (Tá»•ng: ${p.totalScore})`).join('\n');
            const currentPlayer = game.players[game.currentPlayerIndex];

            return interaction.reply(`Tráº¡ng thÃ¡i hiá»‡n táº¡i cá»§a bÃ n chÆ¡i:\n\n${players}\n\nÄáº¿n lÆ°á»£t cá»§a **${currentPlayer.username}**. Game Ä‘ang á»Ÿ tráº¡ng thÃ¡i: **${gameState}**`);
        }

        // Logic xá»­ lÃ½ cÃ¡c subcommand khÃ¡c sáº½ Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã¢y
        const remainingCommand = interaction.options.getSubcommand();
        if(remainingCommand) {
            await interaction.reply({ content: `Lá»‡nh '${remainingCommand}' Ä‘ang Ä‘Æ°á»£c xÃ¢y dá»±ng!`, ephemeral: true });
        }
    },
}; 